> Kubeflow ì‚¬ìš© ì‹œ SSL ì„¤ì •ì„ í•˜ì§€ ì•Šìœ¼ë©´ Http Post ìš”ì²­ ì‹œ ì•„ë˜ì™€ ê°™ì€ ì—ëŸ¬ ë°œìƒí•¨   
> `[403] Could not find CSRF cookie XSRF-TOKEN in the request.`  

> ğŸ™†â€â™‚ï¸ í•˜ë‚˜í•˜ë‚˜ ì˜ˆì™¸ì²˜ë¦¬í•˜ê¸°ë„ ë²ˆê±°ë¡­ê³  ì‹¤ì œ ìš´ì˜ í™˜ê²½ì— ì í•©í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ë°˜ë“œì‹œ SSL ì„¤ì • í•˜ëŠ” ê²ƒì„ ê¶Œì¥í•¨

# SSL ì¸ì¦ì„œ ìƒì„±

```bash
# snap Install
dnf -y install bind-utils
dnf -y install https://dl.fedoraproject.org/pub/epel/epel-release-latest-8.noarch.rpm
dnf -y upgrade --exclude=kubelet,kubeadm,kubectl
yum -y install snapd
systemctl enable --now snapd.socket
ln -s /var/lib/snapd/snap /snap
 
# ì¸ì¦ì„œ ë°œê¸‰ì„ ìœ„í•œ certbot ì„¤ì¹˜
snap install certbot --classic
# ì•„ë˜ ì—ëŸ¬ ë°œìƒ ì‹œ í•œë²ˆ ë” ì‹¤í–‰
## error: too early for operation, device not yet seeded or device model not acknowledged
sleep 10;
snap install certbot --classic


# ì¸ì¦ì„œ ë°œê¸‰ í•˜ê³ ì í•˜ëŠ” ë„ë©”ì¸ì˜ DNS Query
nslookup kubeflow.wooyoung85.net
dig A kubeflow.wooyoung85.net
 
# bash shell ìƒˆë¡œê³ ì¹¨
exec bash

# SSL ì¸ì¦ì„œ ìƒì„±
## ì œê°€ ë³´ìœ í•œ wooyoung85.net ë„ë©”ì¸ì„ í™œìš©í•œ ì˜ˆì‹œ
$> certbot certonly --manual --preferred-challenges dns -d kubeflow.wooyoung85.net
Saving debug log to /var/log/letsencrypt/letsencrypt.log
Enter email address or hit Enter to skip.
 (Enter 'c' to cancel): wy.seo@lgcns.com

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Please read the Terms of Service at:
https://letsencrypt.org/documents/LE-SA-v1.5-February-24-2025.pdf
You must agree in order to register with the ACME server. Do you agree?
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
(Y)es/(N)o: Y

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Would you be willing, once your first certificate is successfully issued, to
share your email address with the Electronic Frontier Foundation, a founding
partner of the Let's Encrypt project and the non-profit organization that
develops Certbot? We'd like to send you email about our work encrypting the web,
EFF news, campaigns, and ways to support digital freedom.
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
(Y)es/(N)o: Y
Account registered.
Requesting a certificate for kubeflow.wooyoung85.net

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Please deploy a DNS TXT record under the name:

_acme-challenge.kubeflow.wooyoung85.net.

with the following value:

GHs9sw9AYJsjvvRc1jC3Cm0sRVMT7YotZlmLFY8V0vs

Before continuing, verify the TXT record has been deployed. Depending on the DNS
provider, this may take some time, from a few seconds to multiple minutes. You can
check if it has finished deploying with aid of online tools, such as the Google
Admin Toolbox: https://toolbox.googleapps.com/apps/dig/#TXT/_acme-challenge.kubeflow.wooyoung85.net.
Look for one or more bolded line(s) below the line ';ANSWER'. It should show the
value(s) you've just added.

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Press Enter to Continue

Successfully received certificate.
Certificate is saved at: /etc/letsencrypt/live/kubeflow.wooyoung85.net/fullchain.pem
Key is saved at:         /etc/letsencrypt/live/kubeflow.wooyoung85.net/privkey.pem
This certificate expires on 2025-06-12.
These files will be updated when the certificate renews.

NEXT STEPS:
- This certificate will not be renewed automatically. Autorenewal of --manual certificates requires the use of an authentication hook script (--manual-auth-hook) but one was not provided. To renew this certificate, repeat this same certbot command before the certificate's expiry date.

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
If you like Certbot, please consider supporting our work by:
 * Donating to ISRG / Let's Encrypt:   https://letsencrypt.org/donate
 * Donating to EFF:                    https://eff.org/donate-le
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
```


- letsencrypt ë¥¼ í†µí•´ ìƒì„±í•œ DNS TXT record AWS Route 53 ì— ë°°í¬
```bash
Please deploy a DNS TXT record under the name:
_acme-challenge.kubeflow.wooyoung85.net.

with the following value:
GHs9sw9AYJsjvvRc1jC3Cm0sRVMT7YotZlmLFY8V0vs
```

- ì•„ë˜ ë§í¬ì—ì„œ DNS TXT Record ê°€ ì˜ ë°°í¬ë˜ì—ˆëŠ”ì§€ í™•ì¸  
https://toolbox.googleapps.com/apps/dig/#TXT/_acme-challenge.kubeflow.wooyoung85.net


# Kubernetes Ingress ì— ì¸ì¦ì„œ ì ìš©

```bash
ll /etc/letsencrypt/live/kubeflow.wooyoung85.net/

kubectl create secret tls kubeflow-tls-secret \
--key /etc/letsencrypt/live/kubeflow.wooyoung85.net/privkey.pem \
--cert /etc/letsencrypt/live/kubeflow.wooyoung85.net/fullchain.pem \
-n istio-system

kubectl get secret -n istio-system

# Ingress ì„¤ì • 
cat <<EOF | tee ~/kf-ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: kf-ingress
  namespace: istio-system
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /  # ìš”ì²­ ê²½ë¡œë¥¼ ë¦¬ë‹¤ì´ë ‰íŠ¸
    nginx.ingress.kubernetes.io/proxy-body-size: "1000m"
spec:
  tls:
  - hosts:
    - kubeflow.wooyoung85.net
    secretName: kubeflow-tls-secret
  ingressClassName: "nginx"  # NGINX Ingress Controller ì‚¬ìš©
  rules:
  - host: kubeflow.wooyoung85.net
    http:
      paths:
      - pathType: Prefix
        path: /
        backend:
          service:
            name: istio-ingressgateway
            port:
              number: 80
EOF
kubectl apply -f ~/kf-ingress.yaml
```

# HAProxy SSL SSL Passthrough ì„¤ì •

> Ingress ì— SSL ì¸ì¦ì„œ ì„¤ì •ë˜ì–´ ìˆê¸° ë•Œë¬¸ì— LB ì—­í• ì„ í•˜ëŠ” HAProxy ëŠ” SSL ì¸ì¦ì„œ ì²˜ë¦¬ë¥¼ ë”°ë¡œ í•˜ì§€ ì•Šê³  í†µê³¼ì‹œí‚´

```bash
tee /etc/haproxy/haproxy.cfg <<- HAPROXY_CONFIG
#---------------------------------------------------------------------
# Global settings
#---------------------------------------------------------------------
global
    log         /dev/log    local0   debug
    chroot      /var/lib/haproxy
    pidfile     /var/run/haproxy.pid
    maxconn     4000
    user        haproxy
    group       haproxy
    daemon
 
#---------------------------------------------------------------------
# Default settings
#---------------------------------------------------------------------
defaults
    mode                    tcp                                    # ì¸ìŠ¤í„´ìŠ¤ê°€ ì²˜ë¦¬í•  í”„ë¡œí† ì½œ
    log                     global
    option                  tcplog                                 # TCP ë¡œê·¸ í¬ë§· ì‚¬ìš©
    option                  dontlognull                            # null connection(health checkìš© connection)ì— ëŒ€í•œ ë¡œê¹… í™œì„±í™”
    timeout connect         10s
    timeout client          30s                                    # clientì™€ì˜ ì—°ê²° ìµœëŒ€ ìœ ì§€ ì‹œê°„
    timeout server          30s                                    # serverì™€ì˜ ì—°ê²° ìµœëŒ€ ìœ ì§€ ì‹œê°„
 
#---------------------------------------------------------------------
# Frontend configuration for HTTP
#---------------------------------------------------------------------
frontend http_front
    bind *:80
    default_backend http_back
 
#---------------------------------------------------------------------
# Frontend configuration for HTTPS (SSL passthrough)
#---------------------------------------------------------------------
frontend https_front
    bind *:443
    mode tcp
    default_backend https_back

#---------------------------------------------------------------------
# Backend configuration for HTTP
#---------------------------------------------------------------------
backend http_back
    balance roundrobin
    server web1 127.0.0.1:31001 check

#---------------------------------------------------------------------
# Backend configuration for HTTPS (SSL passthrough)
#---------------------------------------------------------------------
backend https_back
    balance roundrobin
    server web1 127.0.0.1:31002 check  # HTTPS ì„œë²„
HAPROXY_CONFIG
 
systemctl restart haproxy
systemctl status haproxy --no-pager
```