# Keycloak Install (with. Helm)

> `Nginx Ingress Controller` ì—ì„œ `HTTPS` íŠ¸ë˜í”½ì„ ê·¸ëŒ€ë¡œ `Keycloak` ì— ì „ë‹¬í•˜ëŠ” ì„¤ì •

```bash
# ì‘ì—… ë””ë ‰í† ë¦¬ ì´ë™
mkdir -p /root/files/keycloak
cd /root/files/keycloak

# ê°œì¸ í‚¤ ìƒì„±
openssl genrsa -out keycloak.key 2048

# ì¸ì¦ì„œ ì„œëª… ìš”ì²­ (CSR) ìƒì„±
openssl req -new -key keycloak.key -out keycloak.csr -subj "/CN=keycloak.local"

# ìì²´ ì„œëª…ëœ ì¸ì¦ì„œ ìƒì„± (3650ì¼ ìœ íš¨)
openssl x509 -req -days 3650 -in keycloak.csr -signkey keycloak.key -out keycloak.crt

kubectl create ns keycloak
kubectl create secret tls keycloak-tls-secret \
  --cert=/root/files/keycloak/keycloak.crt \
  --key=/root/files/keycloak/keycloak.key \
  -n keycloak

# Helm ì €ì¥ì†Œ ì¶”ê°€ ë° ì—…ë°ì´íŠ¸
helm repo add bitnami https://charts.bitnami.com/bitnami
helm repo update
helm repo list

helm pull bitnami/keycloak --version 24.4.9

tar -xvf keycloak-24.4.9.tgz

cat <<EOF | tee /root/files/keycloak/override_values.yaml
auth:
  adminUser: admin
  adminPassword: "admin"
tls:
  enabled: true
  autoGenerated: false
  existingSecret: keycloak-tls-secret
  usePem: true
postgresql:
  enabled: true     # external DB ì‚¬ìš©í•  ê²½ìš° falseë¡œ ë³€ê²½
  auth:
    postgresPassword: "test123"
    username: admin_keycloak
    password: "test123"
    database: db_keycloak
  architecture: standalone
EOF

cd /root/files/keycloak
helm upgrade -i keycloak keycloak-24.4.9.tgz  --namespace=keycloak --create-namespace -f /root/files/keycloak/override_values.yaml

# ì‚­ì œ
# helm delete keycloak -n keycloak
# kubectl delete namespace keycloak --force --grace-period=0
```


# SSL ì¸ì¦ì„œ ìƒì„±

```bash
$> certbot certonly --manual --preferred-challenges dns -d keycloak.wooyoung85.net
...
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Please deploy a DNS TXT record under the name:

_acme-challenge.keycloak.wooyoung85.net.

with the following value:

GHs9sw9AYJsjvvRc1jC3Cm0sRVMT7YotZlmLFY8V0vs

Before continuing, verify the TXT record has been deployed. Depending on the DNS
provider, this may take some time, from a few seconds to multiple minutes. You can
check if it has finished deploying with aid of online tools, such as the Google
Admin Toolbox: https://toolbox.googleapps.com/apps/dig/#TXT/_acme-challenge.keycloak.wooyoung85.net.
Look for one or more bolded line(s) below the line ';ANSWER'. It should show the
value(s) you ve just added.
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
...
```


# Kubernetes Ingress ì— ì¸ì¦ì„œ ì ìš©

```bash 
ll /etc/letsencrypt/live/keycloak.wooyoung85.net/

kubectl create secret tls keycloak-ingress-tls-secret \
--key /etc/letsencrypt/live/keycloak.wooyoung85.net/privkey.pem \
--cert /etc/letsencrypt/live/keycloak.wooyoung85.net/fullchain.pem \
-n keycloak

kubectl get secret -n keycloak keycloak-tls-secret

cat <<EOF | tee ~/keycloak-ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: keycloak-ingress
  namespace: keycloak
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /  # ìš”ì²­ ê²½ë¡œë¥¼ ë¦¬ë‹¤ì´ë ‰íŠ¸
    nginx.ingress.kubernetes.io/backend-protocol: "HTTPS"
spec:
  tls:
  - hosts:
    - keycloak.wooyoung85.net
    secretName: keycloak-ingress-tls-secret
  ingressClassName: "nginx"  # NGINX Ingress Controller ì‚¬ìš©
  rules:
  - host: keycloak.wooyoung85.net
    http:
      paths:
      - pathType: Prefix
        path: /
        backend:
          service:
            name: keycloak
            port:
              number: 443
EOF
kubectl apply -f ~/keycloak-ingress.yaml
```

<br/><br/><br/>

# SSL Termination ì„¤ì • (ì°¸ê³ ìš©)

- `proxy: edge` ë¥¼ ì‚¬ìš©í•˜ë©´ `keycloak` ë‚´ë¶€ì—ì„œ `SSL` í†µì‹ í•˜ì§€ ì•Šë„ë¡ êµ¬ì„±í•  ìˆ˜ ìˆìŒ
- `Nginx Ingress Controller` ì—ì„œ `SSL Termination` í•˜ëŠ” ì„¤ì • (`keycloak` ì—°ê²° í¬íŠ¸ `80`)
- ì•„ë˜ ë‚´ìš©ì€ ì°¸ê³ í•˜ê¸° ìœ„í•´ ë‚¨ê²¨ë‘” ê²ƒì„  
ğŸ™ƒ ì¤‘ìš” ì •ë³´ë¥¼ ë‹¤ë£¨ëŠ” ì‹œìŠ¤í…œì€ í´ëŸ¬ìŠ¤í„° ë‚´ì—ì„œë„ SSL í†µì‹ í•˜ëŠ” ê²ƒì„ ê¶Œì¥í•¨

```bash
cd /root/files/keycloak

# Keycloak Helm Values ì„¤ì •
cat <<EOF | tee /root/files/keycloak/override_values.yaml
auth:
  adminUser: admin
  adminPassword: "admin"
tls:
  enabled: false
  autoGenerated: false
proxy: edge         # SSL Termination
postgresql:
  enabled: true     # external DB ì‚¬ìš©í•  ê²½ìš° falseë¡œ ë³€ê²½ 
  auth:
    postgresPassword: "test123"
    username: admin_keycloak
    password: "test123"
    database: db_keycloak
  architecture: standalone
EOF

helm install keycloak keycloak-24.4.9.tgz  --namespace=keycloak --create-namespace -f /root/files/keycloak/override_values.yaml

# SSL ì¸ì¦ì„œ ìƒì„±
...

# Ingress ì„¤ì • 
cat <<EOF | tee ~/keycloak-ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: keycloak-ingress
  namespace: keycloak
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /  # ìš”ì²­ ê²½ë¡œë¥¼ ë¦¬ë‹¤ì´ë ‰íŠ¸
spec:
  tls:
  - hosts:
    - keycloak.wooyoung85.net
    secretName: keycloak-tls-secret
  ingressClassName: "nginx"  # NGINX Ingress Controller ì‚¬ìš©
  rules:
  - host: keycloak.wooyoung85.net
    http:
      paths:
      - pathType: Prefix
        path: /
        backend:
          service:
            name: keycloak
            port:
              number: 80
EOF
kubectl apply -f ~/keycloak-ingress.yaml
```









